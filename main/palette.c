/*
  cxNES - NES/Famicom Emulator
  Copyright (C) 2011-2016 Ryan Jackson

  This program is free software; you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation.; either version 2 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License along
  with this program; if not, write to the Free Software Foundation, Inc.,
  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
*/

#include <stdlib.h>
#include <stdint.h>
#include <math.h>

#include "file_io.h"

/* RC2C05*, RP2C03B and RC2C0C have the same palette */

/* RC2C03B differs at 0x17, 0x25, 0x09, 0x29, 0x39 */

const uint8_t palette_firebrandx_nes_classic[64 * 3] = {
	0x60,0x60,0x60, 0x00,0x00,0x83, 0x1f,0x06,0x9e, 0x38,0x0f,0x7c,
	0x56,0x0c,0x62, 0x5b,0x00,0x10, 0x53,0x0c,0x00, 0x3a,0x23,0x08,
	0x20,0x35,0x0b, 0x0c,0x41,0x0b, 0x19,0x45,0x16, 0x02,0x3e,0x1e,
	0x02,0x31,0x54, 0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00,
	0xa9,0xa9,0xa9, 0x10,0x4b,0xbf, 0x4a,0x1e,0xe4, 0x69,0x0a,0xd2,
	0x8e,0x12,0xb2, 0x9e,0x0f,0x4c, 0x8f,0x32,0x04, 0x73,0x51,0x06,
	0x5c,0x6a,0x12, 0x18,0x7d,0x10, 0x14,0x81,0x09, 0x11,0x75,0x47,
	0x1d,0x66,0x8f, 0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00,
	0xfb,0xfb,0xfb, 0x66,0x99,0xf8, 0x89,0x78,0xfe, 0xb2,0x62,0xff,
	0xde,0x63,0xff, 0xeb,0x69,0xb3, 0xe3,0x87,0x58, 0xc8,0x9f,0x22,
	0xa7,0xb1,0x03, 0x73,0xc2,0x03, 0x5d,0xd0,0x4f, 0x36,0xc5,0x8d,
	0x50,0xc5,0xcc, 0x40,0x40,0x40, 0x00,0x00,0x00, 0x00,0x00,0x00,
	0xfb,0xfb,0xfb, 0xbf,0xd4,0xfa, 0xcd,0xcb,0xfe, 0xd9,0xc2,0xff,
	0xec,0xbe,0xff, 0xfa,0xc2,0xeb, 0xf7,0xca,0xc3, 0xe3,0xcd,0xa7,
	0xd9,0xde,0x9c, 0xc8,0xe6,0x9e, 0xc0,0xe6,0xb8, 0xb5,0xed,0xc7,
	0xb9,0xe6,0xea, 0xb8,0xb8,0xb8, 0x00,0x00,0x00, 0x00,0x00,0x00,
};

const uint8_t palette_firebrandx_nostalgia[64 * 3] = {
	0x65,0x65,0x65, 0x00,0x12,0x7d, 0x18,0x00,0x8e, 0x36,0x00,0x82,
	0x56,0x00,0x5d, 0x5a,0x00,0x18, 0x4f,0x05,0x00, 0x38,0x19,0x00,
	0x1d,0x31,0x00, 0x00,0x3d,0x00, 0x00,0x41,0x00, 0x00,0x3b,0x17,
	0x00,0x2e,0x55, 0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00,
	0xaf,0xaf,0xaf, 0x19,0x4e,0xc8, 0x47,0x2f,0xe3, 0x6b,0x1f,0xd7,
	0x93,0x1b,0xae, 0x9e,0x1a,0x5e, 0x97,0x32,0x00, 0x7b,0x4b,0x00,
	0x5b,0x67,0x00, 0x26,0x7a,0x00, 0x00,0x82,0x00, 0x00,0x7a,0x3e,
	0x00,0x6e,0x8a, 0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00,
	0xff,0xff,0xff, 0x64,0xa9,0xff, 0x8e,0x89,0xff, 0xb6,0x76,0xff,
	0xe0,0x6f,0xff, 0xef,0x6c,0xc4, 0xf0,0x80,0x6a, 0xd8,0x98,0x2c,
	0xb9,0xb4,0x0a, 0x83,0xcb,0x0c, 0x5b,0xd6,0x3f, 0x4a,0xd1,0x7e,
	0x4d,0xc7,0xcb, 0x4c,0x4c,0x4c, 0x00,0x00,0x00, 0x00,0x00,0x00,
	0xff,0xff,0xff, 0xc7,0xe5,0xff, 0xd9,0xd9,0xff, 0xe9,0xd1,0xff,
	0xf9,0xce,0xff, 0xff,0xcc,0xf1, 0xff,0xd4,0xcb, 0xf8,0xdf,0xb1,
	0xed,0xea,0xa4, 0xd6,0xf4,0xa4, 0xc5,0xf8,0xb8, 0xbe,0xf6,0xd3,
	0xbf,0xf1,0xf1, 0xb9,0xb9,0xb9, 0x00,0x00,0x00, 0x00,0x00,0x00,
};

const uint8_t palette_rp2c03b[64 * 3] = {
	0x6d,0x6d,0x6d, 0x00,0x24,0x92, 0x00,0x00,0xdb, 0x6d,0x49,0xdb,
	0x92,0x00,0x6d, 0xb6,0x00,0x6d, 0xb6,0x24,0x00, 0x92,0x49,0x00,
	0x6d,0x49,0x00, 0x24,0x49,0x00, 0x00,0x6d,0x24, 0x00,0x92,0x00,
	0x00,0x49,0x49, 0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00,
	0xb6,0xb6,0xb6, 0x00,0x6d,0xdb, 0x00,0x49,0xff, 0x92,0x00,0xff,
	0xb6,0x00,0xff, 0xff,0x00,0x92, 0xff,0x00,0x00, 0xdb,0x6d,0x00,
	0x92,0x6d,0x00, 0x24,0x92,0x00, 0x00,0x92,0x00, 0x00,0xb6,0x6d,
	0x00,0x92,0x92, 0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00,
	0xff,0xff,0xff, 0x6d,0xb6,0xff, 0x92,0x92,0xff, 0xdb,0x6d,0xff,
	0xff,0x00,0xff, 0xff,0x6d,0xff, 0xff,0x92,0x00, 0xff,0xb6,0x00,
	0xdb,0xdb,0x00, 0x6d,0xdb,0x00, 0x00,0xff,0x00, 0x49,0xff,0xdb,
	0x00,0xff,0xff, 0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00,
	0xff,0xff,0xff, 0xb6,0xdb,0xff, 0xdb,0xb6,0xff, 0xff,0xb6,0xff,
	0xff,0x92,0xff, 0xff,0xb6,0xb6, 0xff,0xdb,0x92, 0xff,0xff,0x49,
	0xff,0xff,0x6d, 0xb6,0xff,0x49, 0x92,0xff,0x6d, 0x49,0xff,0xdb,
	0x92,0xdb,0xff, 0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00
};

const uint8_t palette_rc2c03b[64 * 3] = {
	0x6d,0x6d,0x6d, 0x00,0x24,0x92, 0x00,0x00,0xdb, 0x6d,0x49,0xdb,
	0x92,0x00,0x6d, 0xb6,0x00,0x6d, 0xb6,0x24,0x00, 0x92,0x49,0x00,
	0x6d,0x49,0x00, 0x24,0x00,0x00, 0x00,0x6d,0x24, 0x00,0x92,0x00,
	0x00,0x49,0x49, 0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00,
	0xb6,0xb6,0xb6, 0x00,0x24,0xdb, 0x00,0x49,0xff, 0x92,0x00,0xff,
	0xb6,0x00,0xff, 0xff,0x00,0x92, 0xff,0x00,0x00, 0xdb,0x6d,0x00,
	0x92,0x6d,0x00, 0x24,0x92,0x00, 0x00,0x92,0x00, 0x00,0xb6,0x6d,
	0x00,0x92,0x92, 0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00,
	0xff,0xff,0xff, 0x6d,0xb6,0xff, 0x92,0x92,0xff, 0xdb,0x6d,0xff,
	0xff,0x00,0xff, 0xff,0x24,0xff, 0xff,0x92,0x00, 0xff,0xb6,0x00,
	0xdb,0xdb,0x00, 0x6d,0x92,0x00, 0x00,0xff,0x00, 0x49,0xff,0xdb,
	0x00,0xff,0xff, 0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00,
	0xff,0xff,0xff, 0xb6,0x92,0xff, 0xdb,0xb6,0xff, 0xff,0xb6,0xff,
	0xff,0x92,0xff, 0xff,0xb6,0xb6, 0xff,0xdb,0x92, 0xff,0xff,0x49,
	0xff,0xff,0x6d, 0xb6,0xb6,0x49, 0x92,0xff,0x6d, 0x49,0xff,0xdb,
	0x92,0xdb,0xff, 0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00
};

/* The RP2C04 palettes, reordered to be as close as possible to the
   RP2C03 palette.
*/
const uint8_t palette_rp2c04_master[64 * 3] = {
	0x6d,0x6d,0x6d, 0x00,0x24,0x92, 0x00,0x00,0xdb, 0x6d,0x49,0xdb,
	0x92,0x00,0x6d, 0xb6,0x00,0x6d, 0xb6,0x24,0x00, 0x92,0x49,0x00,
	0x6d,0x49,0x00, 0x24,0x49,0x00, 0x00,0x6d,0x24, 0x00,0x00,0x00,
	0x00,0x49,0x49, 0x24,0x24,0x24, 0x00,0x00,0x6d, 0x00,0x00,0x00,
	0xb6,0xb6,0xb6, 0x00,0x6d,0xdb, 0x00,0x49,0xff, 0x92,0x00,0xff,
	0xb6,0x00,0xff, 0xff,0x00,0x92, 0xff,0x00,0x00, 0xdb,0x6d,0x00,
	0x92,0x6d,0x00, 0x24,0x92,0x00, 0x00,0x92,0x00, 0x00,0xb6,0x6d,
	0x00,0x92,0x92, 0x49,0x49,0x49, 0x49,0x00,0x00, 0x6d,0x24,0x00,
	0xff,0xff,0xff, 0x6d,0xb6,0xff, 0x92,0x92,0xff, 0xdb,0x6d,0xff,
	0xff,0x00,0xff, 0xff,0x6d,0xff, 0xff,0x92,0x00, 0xff,0xb6,0x00,
	0xd7,0xdb,0x00, 0x6d,0xdb,0x00, 0x00,0xff,0x00, 0x00,0x00,0x00,
	0x00,0xff,0xff, 0x92,0x92,0x92, 0x00,0x00,0x00, 0x00,0x49,0x00,
	0xff,0xff,0xff, 0xb6,0xdb,0xff, 0xdb,0xb6,0xff, 0xff,0xb6,0xff,
	0xff,0x92,0xff, 0xff,0xb6,0xb6, 0xff,0xdb,0x92, 0xff,0xff,0x00,
	0xff,0xff,0x6d, 0xb6,0xff,0x49, 0x92,0xff,0x6d, 0x49,0xff,0xdb,
	0x92,0xdb,0xff, 0xdb,0xdb,0xdb, 0xdb,0xb6,0x6d, 0xff,0xdb,0x00,
};

/* Applies the emphasis used by RGB PPUs to a 64-color palette */
/* palette is a pointer to an array of 512 * 3 uint8_t */
/* The first 64 colors of the palette must already be set */
void palette_rgb_emphasis(uint8_t * palette)
{
	int i, j;
	uint8_t emph[8 * 3] = {
		0x00,0x00,0x00, 0x00,0x00,0xff, 0x00,0xff,0x00, 0x00,0xff,0xff,
		0xff,0x00,0x00, 0xff,0x00,0xff, 0xff,0xff,0x00, 0xff,0xff,0xff
	};

	for (i = 1; i < 8; i++) {
		for (j = 0; j < 64; j++) {
			palette[(i * 64 * 3) + (j * 3) + 0] = palette[j * 3 + 0] | emph[i + 0];
			palette[(i * 64 * 3) + (j * 3) + 1] = palette[j * 3 + 1] | emph[i + 1];
			palette[(i * 64 * 3) + (j * 3) + 2] = palette[j * 3 + 2] | emph[i + 2];
		}
	}
}

/* filename is the filename containing the palette, *palette points
   to a 512-color palette of uint8_ts
*/
int load_external_palette(uint8_t *palette, const char *filename)
{
	int size;

	if (!palette)
		return -1;

	size = get_file_size(filename);
	if (size < 192)
		return -1;

	if (size < 1536)
		size = 192;
	else
		size = 1536;

	if (readfile(filename, palette, size) != 0) {
		return -1;
	}

	return size / 3;
}
